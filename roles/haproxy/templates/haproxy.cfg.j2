#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon

    maxconn 50000

    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s

#---------------------------------------------------------------------
# Default settings
#---------------------------------------------------------------------
defaults
    log     global
    mode    http

    option  httplog
    option  dontlognull
    option  redispatch

    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-request 10s
    timeout queue 30s

    retries 3

#---------------------------------------------------------------------
# Frontend - HTTP (Ingress)
#---------------------------------------------------------------------
frontend ingress_http
    bind *:80
    mode http

    default_backend ingress_backends

#---------------------------------------------------------------------
# Backend - Kubernetes Ingress Controllers (NodePort)
#---------------------------------------------------------------------
backend ingress_backends
    mode http
    balance roundrobin

    option tcp-check

    {% for host in groups['k3s_agents'] %}
    server {{ host }} {{ hostvars[host].ansible_host }}:{{ haproxy_ingress_nodeport | default(30080) }} check
    {% endfor %}
