---
# roles/k3s-control-plane/tasks/main.yml

# ------------------------------------------------------------
# Build K3s server install flags
# ------------------------------------------------------------

- name: Build K3s server install arguments
  set_fact:
    k3s_server_exec: >-
      server
      {% for component in k3s_disable_components %}
      --disable {{ component }}
      {% endfor %}
      --node-name {{ k3s_node_name }}
      --write-kubeconfig-mode 644
      {% for arg in k3s_extra_args %}
      {{ arg }}
      {% endfor %}

# ------------------------------------------------------------
# Install K3s server (control plane)
# ------------------------------------------------------------

- name: Check if K3s server is already installed
  stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Download and install K3s server
  shell: |
    curl -sfL https://get.k3s.io | \
    INSTALL_K3S_VERSION="{{ k3s_version }}" \
    INSTALL_K3S_EXEC="{{ k3s_server_exec }}" \
    sh -
  args:
    creates: /usr/local/bin/k3s
  become: true
  when: not k3s_binary.stat.exists

# ------------------------------------------------------------
# Ensure K3s service is enabled and running
# ------------------------------------------------------------

- name: Enable and start K3s service
  systemd:
    name: k3s
    enabled: true
    state: started
  become: true
  changed_when: false

# ------------------------------------------------------------
# Wait for Kubernetes API to be ready
# ------------------------------------------------------------

- name: Wait for Kubernetes API to be available
  command: kubectl get nodes
  register: k3s_api_check
  retries: 10
  delay: 10
  until: k3s_api_check.rc == 0
  changed_when: false
  become: true

# ------------------------------------------------------------
# Validate control plane node is Ready
# ------------------------------------------------------------

- name: Validate control plane node is Ready
  command: kubectl get nodes --no-headers
  register: k3s_nodes_status
  retries: 10
  delay: 10
  until: "' Ready ' in k3s_nodes_status.stdout"
  changed_when: false
  become: true

# ------------------------------------------------------------
# Read K3s node token (for future agent joins)
# ------------------------------------------------------------

- name: Read K3s node token
  slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_node_token
  become: true

- name: Set K3s join token fact (control plane)
  set_fact:
    k3s_join_token: "{{ k3s_node_token.content | b64decode | trim }}"

- name: Expose K3s join token for other hosts (hostvars)
  set_fact:
    k3s_control_plane_token: "{{ k3s_join_token }}"

# ------------------------------------------------------------
# Ensure kubeconfig permissions for non-root users
# ------------------------------------------------------------

- name: Ensure kubeconfig has correct permissions
  file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: "0644"
  become: true